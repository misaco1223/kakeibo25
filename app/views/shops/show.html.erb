<div class="mx-w-md w-full">
  <div>
    <div style="paddig-top:0px;">
      <%= link_to shops_path, class: "btn btn-ghost text-sm", style:"padding-right: 0px; width:auto;" do %>
        <i class="fa-regular fa-folder"></i>店舗<i class="fa-solid fa-chevron-right"></i>
      <% end %>
      <%= link_to "", class: "btn btn-ghost text-sm", style:"padding-left:0px; padding-right: 0px; width:auto; " do %>
        <i class="fa-regular fa-folder"></i><%= @shop.name %>
      <% end %>
    </div>
    <a class="btn btn-ghost text-xl gray-900" href="/"><%= @shop.name %>の支出一覧</a>
  </div>
</div>

<div class="navbar px-4 mb-2">
  <p class="font-bold">支出合計: <%= @total_amount %>円</h1>
</div>

<!-- 絞り込みフォーム -->
<div class="mx-w-300 justify-start">
  <div class="max-w-md border border-gray-300 font-sm">
    <div class="flex">
      <h1 class="mb-4 mx-4 mt-4">絞り込み欄</h1>
       <%= link_to shop_path(@shop), class: "mx-4 mt-4" do %><i class="fa-solid fa-rotate-left"></i><% end %>
      <button id="toggleFilter"><i class="fa-regular fa-eye-slash"></i></button>
    </div>

    <div id="filterForm" class="hidden">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <%= form_with url: shop_path(@shop), method: :get, local: true do %>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
          <!-- 年月フィルタ -->
          <div class="flex flex-col" style="padding:4px; margin-bottom:4px;">
            <%= label_tag :year_month_filter, "予算の設定月", class: "block mb-2 text-sm" %>
            <%= select_tag :year_month_filter, options_for_select(
                [['選択してください', '']] + @budgets.distinct.pluck(:year_month).map { |year_month| 
                formatted_year_month = Date.strptime(year_month, "%Y-%m").strftime("%Y年-%m月")
                [formatted_year_month, year_month]
                },
                params[:year_month_filter]
                ), class: 'select select-bordered text-sm', onchange: 'this.form.submit();' %>
          </div>

          <!-- 支払い方法フィルタ -->
          <div class="flex flex-col" style="padding:4px; margin-bottom:4px;">
            <%= label_tag :pay_method_filter, "店舗", class: "block mb-2 text-sm" %>
            <%= select_tag :pay_method_filter, options_for_select(
                    [['選択してください', '']] + @pay_methods.map { |method| [method.name, method.id] },
                    params[:pay_method_filter]
                    ), class: 'select select-bordered text-sm', onchange: 'this.form.submit();' %>
          </div>
        </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<br>

<!-- 支出データテーブル -->
<div class="overflow-x-auto">
  <table class="table">
    <thead>
      <tr>
        <th>日付</th>
        <th>ファイル</th>
        <th>カテゴリー</th>
        <th>タイトル</th>
        <th>金額</th>
        <th>支払い方法</th>
      </tr>
    </thead>
    <tbody>
      <% @payments.each do |payment| %>
        <tr style="height:80px;">
          <td style="padding:0; text-align:center;">
            <%= payment.date.strftime('%Y-%m-%d') %>
          </td>
          <td style="padding:0; text-align:center;">
            <%= link_to payment.budget.money_file&.title, money_file_path(payment.budget.money_file),class:"underline" %>
          </td>
          <td style="padding:0; text-align:center;">
            <%= payment.budget.category&.name %>
          </td>
          <td style="padding:0; text-align:center;">
            <%= link_to payment.title, budget_path(payment.budget),class: "underline" %>
          </td>
          <td style="padding:0; text-align:center;">
            <%= payment.amount %>円
          </td>
          <td style="padding:0; text-align:center;">
            <%= payment.pay_method&.name || "" %>
          </td>
        </tr>
    <% end %>
    </tbody>
    <tfoot>
      <% if params[:year_month_filter].blank? && params[:pay_method_filter].blank? %>
        <tr>
          <td></td>
          <td></td>
          <td style="text-align:right">合計</td>
          <td><%= @total_amount %>円</td>
        </tr>
      <% else %>
        <tr>
          <td></td>
          <td></td>
          <td style="text-align:right">合計</td>
          <td><%= @filtered_total_amount %>円</td>
        </tr>
      <% end %>
    </tfoot>
  </table>
</div>

<script>
  // トグルボタンのクリックイベント
  document.getElementById("toggleFilter").addEventListener("click", function() {
    const filterForm = document.getElementById("filterForm");
    const isHidden = filterForm.classList.contains("hidden");

    if (isHidden) {
      filterForm.classList.remove("hidden"); // 表示
      this.innerHTML = '<i class="fa-regular fa-eye"></i>';
    } else {
      filterForm.classList.add("hidden"); // 非表示
      this.innerHTML = '<i class="fa-regular fa-eye-slash"></i>';
    }
  });
</script>